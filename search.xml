<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>filebeat netflow模块输出kafka多topic问题</title>
    <url>/posts/66ee5de4/</url>
    <content><![CDATA[<h2 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h2><figure class="highlight llvm"><table><tr><td class="code"><pre><span class="line">~ cat /etc/centos-<span class="keyword">release</span></span><br><span class="line">CentOS Linux <span class="keyword">release</span> <span class="number">7.6</span>.<span class="number">1810</span> (Core)</span><br><span class="line">~  yum list installed | grep filebeat</span><br><span class="line">filebeat.<span class="keyword">x</span><span class="number">86</span>_<span class="number">64</span>                        <span class="number">7.10</span>.<span class="number">2</span><span class="number">-1</span>                     <span class="title">@elastic-7.x</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>想让各出口的路由器，通过netflow、netstream将流量送到es保存起来进行分析。之前测试是直接用filebeat output到es的，但考虑到性能问题，决定先将数据送到kafka，通过logstash进行处理再送入es。</p>
<p>因为出口链路较多，设计不同的出口数据，送入不同的filebeat端口，以不同的topic存入kafka，方便管理。</p>
<p>当然，不同流量也可以采用相同的topic，后期在es上根据observer或tag来区分。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>按官网说明，在module中加上 fields.log_topic</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">~</span> <span class="string">grep</span> <span class="string">-v</span> <span class="string">&quot;^\s*#&quot;</span> <span class="string">/etc/filebeat/modules.d/netflow_3055.yml</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">-v</span> <span class="string">^$</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">module:</span> <span class="string">netflow</span></span><br><span class="line">  <span class="attr">log:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">var:</span></span><br><span class="line">      <span class="attr">netflow_host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">      <span class="attr">netflow_port:</span> <span class="number">3055</span></span><br><span class="line">      <span class="attr">internal_networks:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/8</span></span><br><span class="line">      <span class="attr">fields:</span></span><br><span class="line">        <span class="attr">log_topic:</span> <span class="string">ipnce</span></span><br></pre></td></tr></table></figure>

<p>在filebeat.yml中指定topic</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">~</span> <span class="string">grep</span> <span class="string">-v</span> <span class="string">&quot;^\s*#&quot;</span> <span class="string">/etc/filebeat/filebeat.yml</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">-v</span> <span class="string">^$</span></span><br><span class="line"><span class="attr">logging.level:</span> <span class="string">info</span></span><br><span class="line"><span class="attr">logging.to_files:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">logging.files:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/var/log/filebeat</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="attr">keepfiles:</span> <span class="number">7</span></span><br><span class="line">  <span class="attr">permissions:</span> <span class="number">0644</span></span><br><span class="line"><span class="attr">logging.to_syslog:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">filebeat.config.modules:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">$&#123;path.config&#125;/modules.d/*.yml</span></span><br><span class="line">  <span class="attr">reload.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">output:</span></span><br><span class="line">  <span class="attr">kafka:</span></span><br><span class="line">    <span class="attr">output.kafka:</span></span><br><span class="line">      <span class="attr">hosts:</span> [<span class="string">&quot;kafka-1:9092&quot;</span>, <span class="string">&quot;kafka-2:9092&quot;</span>, <span class="string">&quot;kafka-3:9092&quot;</span>]</span><br><span class="line">      <span class="attr">topic:</span> <span class="string">&quot;netstream-<span class="template-variable">%&#123;[fields.log_topic]&#125;</span>&quot;</span></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">add_host_metadata:</span></span><br><span class="line">      <span class="attr">when.not.contains.tags:</span> <span class="string">forwarded</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">add_cloud_metadata:</span> <span class="string">~</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">add_docker_metadata:</span> <span class="string">~</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">add_kubernetes_metadata:</span> <span class="string">~</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>按以上配置，一直报错</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">Dropping even<span class="variable">t:</span> <span class="keyword">no</span> topic could <span class="keyword">be</span> selected</span><br></pre></td></tr></table></figure>

<p>应该是fields中，没有log_topic值，虽然在module中已经设置了，但没有生效。问了google，有些说需要在配置中加上</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">fields_under_root:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>依然无效</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>测试了几天，实在是找不头绪，只能使用全局topic传入kafka，在es上观察数据后，发现netflow的数据在存入es后，有一些特定的字段，比如</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">ecs</span>.version: <span class="number">1</span>.<span class="number">5</span>.<span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>这些字段应该是filebeat默认的模板通过processors加上去的，于是查看了netflow模块的默认模板，果然在processors中发现了ecs.version字段，该yml文件中，还有一些关于module中的变量替换。于是想通过在这里引用module中的vars，设定log_topic。</p>
<p>在末尾添加 log_topic</p>
<figure class="highlight handlebars"><table><tr><td class="code"><pre><span class="line"><span class="xml">~ grep -v &quot;^\s*#&quot; /usr/share/filebeat/module/netflow/log/config/netflow.yml | grep -v ^$</span></span><br><span class="line"><span class="xml">type: netflow</span></span><br><span class="line"><span class="xml">protocols: [v1, v5, v6, v7, v8, v9, ipfix]</span></span><br><span class="line"><span class="xml">host: &#x27;</span><span class="template-variable">&#123;&#123;<span class="name">.netflow_host</span>&#125;&#125;</span><span class="xml">:</span><span class="template-variable">&#123;&#123;<span class="name">.netflow_port</span>&#125;&#125;</span><span class="xml">&#x27;</span></span><br><span class="line"><span class="xml">max_message_size: &#x27;</span><span class="template-variable">&#123;&#123;<span class="name">.max_message_size</span>&#125;&#125;</span><span class="xml">&#x27;</span></span><br><span class="line"><span class="xml">expiration_timeout: &#x27;</span><span class="template-variable">&#123;&#123;<span class="name">.expiration_timeout</span>&#125;&#125;</span><span class="xml">&#x27;</span></span><br><span class="line"><span class="xml">queue_size: </span><span class="template-variable">&#123;&#123;<span class="name">.queue_size</span>&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123;<span class="name"><span class="builtin-name">if</span></span> .timeout&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">timeout: &#x27;</span><span class="template-variable">&#123;&#123;<span class="name">.timeout</span>&#125;&#125;</span><span class="xml">&#x27;</span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123;<span class="name">end</span>&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123;<span class="name"><span class="builtin-name">if</span></span> .read_buffer&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">read_buffer: &#x27;</span><span class="template-variable">&#123;&#123;<span class="name">.read_buffer</span>&#125;&#125;</span><span class="xml">&#x27;</span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123;<span class="name">end</span>&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123; <span class="name"><span class="builtin-name">if</span></span> .custom_definitions&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">custom_definitions:</span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123;<span class="name">range</span> .custom_definitions&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">- &#x27;</span><span class="template-variable">&#123;&#123; . &#125;&#125;</span><span class="xml">&#x27;</span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123;<span class="name">end</span>&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123;<span class="name">end</span>&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123; <span class="name"><span class="builtin-name">if</span></span> .detect_sequence_reset&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">detect_sequence_reset: </span><span class="template-variable">&#123;&#123;<span class="name">.detect_sequence_reset</span>&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123;<span class="name">end</span>&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">tags: </span><span class="template-variable">&#123;&#123;<span class="name">.tags</span> | tojson&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">publisher_pipeline.disable_host: </span><span class="template-variable">&#123;&#123; <span class="name">inList</span> .tags <span class="string">&quot;forwarded&quot;</span> &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">processors:</span></span><br><span class="line"><span class="xml">  - add_fields:</span></span><br><span class="line"><span class="xml">      target: &#x27;&#x27;</span></span><br><span class="line"><span class="xml">      fields:</span></span><br><span class="line"><span class="xml">        ecs.version: 1.5.0</span></span><br><span class="line"><span class="xml">        log_topic: </span><span class="template-variable">&#123;&#123; <span class="name">.log_topic</span>  &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>修改module，添加log_topic变量</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">~</span> <span class="string">grep</span> <span class="string">-v</span> <span class="string">&quot;^\s*#&quot;</span> <span class="string">/etc/filebeat/modules.d/netflow_3055.yml</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">-v</span> <span class="string">^$</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">module:</span> <span class="string">netflow</span></span><br><span class="line">  <span class="attr">log:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">var:</span></span><br><span class="line">      <span class="attr">netflow_host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">      <span class="attr">netflow_port:</span> <span class="number">3055</span></span><br><span class="line">      <span class="attr">tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ipn_ce</span></span><br><span class="line">      <span class="attr">log_topic:</span> <span class="string">ipn_ce</span></span><br><span class="line">      <span class="attr">internal_networks:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/8</span></span><br></pre></td></tr></table></figure>

<p>重启filebeat后，可根据log_topic在kafka中正常生成topic</p>
<figure class="highlight brainfuck"><table><tr><td class="code"><pre><span class="line"><span class="comment">~</span> <span class="comment">kafka</span><span class="literal">-</span><span class="comment">topics</span><span class="string">.</span><span class="comment">sh</span> --<span class="comment">list</span> --<span class="comment">zookeeper</span> <span class="comment">localhost:2181</span></span><br><span class="line"><span class="comment">__consumer_offsets</span></span><br><span class="line"><span class="comment">netstream</span><span class="literal">-</span><span class="comment">ipn_ce</span></span><br></pre></td></tr></table></figure>



<p>能用了，为什么官方配置不行的问题，也不想深究了 。。。</p>
]]></content>
      <categories>
        <category>运维</category>
      </categories>
      <tags>
        <tag>filebeat</tag>
        <tag>netflow</tag>
      </tags>
  </entry>
</search>
